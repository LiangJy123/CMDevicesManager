<Window x:Class="CMDevicesManager.Windows.ColorPickerWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="选择颜色"
        Width="530" Height="380"
        WindowStartupLocation="CenterOwner"
        ResizeMode="NoResize"
        WindowStyle="None"
        AllowsTransparency="True"
        Background="Transparent"
        FontFamily="{DynamicResource AppFontFamily}"
        FocusManager.FocusedElement="{Binding ElementName=TxtHex}">

    <Window.Resources>
        <SolidColorBrush x:Key="CardBg" Color="#232834"/>
        <SolidColorBrush x:Key="CardBorder" Color="#2E3747"/>
        <SolidColorBrush x:Key="TitleBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="SubtitleBrush" Color="#B8C0CC"/>
        <SolidColorBrush x:Key="AccentBrush" Color="#3A7E00"/>
        <SolidColorBrush x:Key="AccentHoverBrush" Color="#4A9E00"/>

        <!-- 外层窗口阴影（WPF 自带，透明窗口时使用） -->
        <DropShadowEffect x:Key="WindowShadow"
                          Color="#000000"
                          Direction="270"
                          ShadowDepth="4"
                          BlurRadius="28"
                          Opacity="0.55"/>

        <DropShadowEffect x:Key="CardShadow" Color="Black"
                          Direction="270" ShadowDepth="8"
                          Opacity="0.45" BlurRadius="18"/>

        <Style x:Key="CardBorderStyle" TargetType="Border">
            <Setter Property="CornerRadius" Value="12"/>
            <Setter Property="Background" Value="{StaticResource CardBg}"/>
            <Setter Property="BorderBrush" Value="{StaticResource CardBorder}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="SnapsToDevicePixels" Value="True"/>
            <Setter Property="Padding" Value="12"/>
            <Setter Property="Effect" Value="{StaticResource CardShadow}"/>
        </Style>

        <Style x:Key="ActionButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource AccentBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="10,6"/>
            <Setter Property="Margin" Value="6,0,0,0"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="bd"
                                CornerRadius="5"
                                Background="{TemplateBinding Background}"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="bd" Property="Background" Value="{StaticResource AccentHoverBrush}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="bd" Property="Background" Value="#2A6E00"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="SecondaryButtonStyle" TargetType="Button" BasedOn="{StaticResource ActionButtonStyle}">
            <Setter Property="Background" Value="#3F3F3F"/>
            <Setter Property="Foreground" Value="#A7A8AA"/>
        </Style>

        <Style x:Key="InputBoxStyle" TargetType="TextBox">
            <Setter Property="Foreground" Value="{StaticResource TitleBrush}"/>
            <Setter Property="Background" Value="#1B202B"/>
            <Setter Property="BorderBrush" Value="{StaticResource CardBorder}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="4,2"/>
            <Setter Property="HorizontalContentAlignment" Value="Center"/>
            <Setter Property="CaretBrush" Value="White"/>
        </Style>
    </Window.Resources>

    <!-- 圆角 + 背景容器 -->
    <Border CornerRadius="18"
            Background="#20252F"
            BorderBrush="#2E3747"
            BorderThickness="1"
            Effect="{StaticResource WindowShadow}"
            SnapsToDevicePixels="True">
        <Grid Margin="14" MouseLeftButtonDown="WindowDragArea_MouseLeftButtonDown">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- 标题 + 关闭 -->
            <Grid Grid.Row="0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBlock Text="颜色选择器"
                           FontSize="18"
                           FontWeight="SemiBold"
                           Foreground="{StaticResource TitleBrush}"
                           VerticalAlignment="Center"
                           Margin="2,0,0,10"/>
                <Button Grid.Column="1"
                        Width="34" Height="28"
                        Content="✕"
                        Style="{StaticResource SecondaryButtonStyle}"
                        Click="CloseButton_Click"
                        ToolTip="关闭" Visibility="Collapsed"/>
            </Grid>

            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="280"/>
                    <ColumnDefinition Width="12"/>
                    <ColumnDefinition Width="200"/>
                    <ColumnDefinition Width="12"/>
                    <ColumnDefinition Width="0"/>
                </Grid.ColumnDefinitions>

                <!-- 色轮 -->
                <Border x:Name="WheelBorder"
                        Grid.Column="0"
                        Style="{StaticResource CardBorderStyle}"
                        Padding="0"
                        VerticalAlignment="Top"
                        SizeChanged="WheelBorder_SizeChanged">
                    <Grid x:Name="WheelContainer">
                        <Image x:Name="ColorWheel"
                               Stretch="Uniform"
                               MouseDown="ColorWheel_MouseDown"
                               MouseMove="ColorWheel_MouseMove"
                               MouseUp="ColorWheel_MouseUp"
                               Cursor="Cross"
                               SnapsToDevicePixels="True"
                               RenderOptions.BitmapScalingMode="HighQuality"
                               Source="/Resources/ColorWheelPicker.png"/>
                        <Canvas x:Name="MarkerLayer" IsHitTestVisible="False">
                            <Ellipse x:Name="Marker"
                                     Width="18" Height="18"
                                     Stroke="#FFFFFFFF"
                                     StrokeThickness="2"
                                     Fill="#40FFFFFF"
                                     Visibility="Collapsed"
                                     Effect="{StaticResource CardShadow}"/>
                        </Canvas>
                    </Grid>
                </Border>

                <!-- RGB / HEX -->
                <Border Grid.Column="2" Style="{StaticResource CardBorderStyle}">
                    <StackPanel>
                        <TextBlock Text="RGB" FontSize="14" FontWeight="SemiBold" Foreground="{StaticResource SubtitleBrush}"/>
                        <Grid Margin="0,10,0,0">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="28"/>
                                <ColumnDefinition Width="70"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <TextBlock Text="R" Grid.Row="0" Grid.Column="0" VerticalAlignment="Center" Foreground="{StaticResource SubtitleBrush}"/>
                            <TextBox x:Name="TxtR" Grid.Row="0" Grid.Column="1" Style="{StaticResource InputBoxStyle}"
                                     PreviewTextInput="Rgb_PreviewTextInput" TextChanged="Rgb_TextChanged"/>
                            <Border x:Name="BarRHost" Grid.Row="0" Grid.Column="2" Height="8" Margin="6,0,0,0" CornerRadius="4" Background="#303030" SizeChanged="BarHost_SizeChanged">
                                <Grid ClipToBounds="True">
                                    <Border x:Name="BarR" CornerRadius="4" Background="#FF4444" HorizontalAlignment="Left" Width="0"/>
                                </Grid>
                            </Border>

                            <TextBlock Text="G" Grid.Row="1" Grid.Column="0" VerticalAlignment="Center" Foreground="{StaticResource SubtitleBrush}" Margin="0,4,0,0"/>
                            <TextBox x:Name="TxtG" Grid.Row="1" Grid.Column="1" Style="{StaticResource InputBoxStyle}" Margin="0,4,0,0"
                                     PreviewTextInput="Rgb_PreviewTextInput" TextChanged="Rgb_TextChanged"/>
                            <Border x:Name="BarGHost" Grid.Row="1" Grid.Column="2" Height="8" Margin="6,4,0,0" CornerRadius="4" Background="#303030" SizeChanged="BarHost_SizeChanged">
                                <Grid ClipToBounds="True">
                                    <Border x:Name="BarG" CornerRadius="4" Background="#44FF44" HorizontalAlignment="Left" Width="0"/>
                                </Grid>
                            </Border>

                            <TextBlock Text="B" Grid.Row="2" Grid.Column="0" VerticalAlignment="Center" Foreground="{StaticResource SubtitleBrush}" Margin="0,4,0,0"/>
                            <TextBox x:Name="TxtB" Grid.Row="2" Grid.Column="1" Style="{StaticResource InputBoxStyle}" Margin="0,4,0,0"
                                     PreviewTextInput="Rgb_PreviewTextInput" TextChanged="Rgb_TextChanged"/>
                            <Border x:Name="BarBHost" Grid.Row="2" Grid.Column="2" Height="8" Margin="6,4,0,0" CornerRadius="4" Background="#303030" SizeChanged="BarHost_SizeChanged">
                                <Grid ClipToBounds="True">
                                    <Border x:Name="BarB" CornerRadius="4" Background="#4488FF" HorizontalAlignment="Left" Width="0"/>
                                </Grid>
                            </Border>
                        </Grid>

                        <Separator Margin="0,12,0,12" Background="{StaticResource CardBorder}" Height="1"/>

                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                            <TextBlock Text="Hex #" Foreground="{StaticResource SubtitleBrush}" VerticalAlignment="Center"/>
                            <TextBox x:Name="TxtHex" Width="90" Margin="8,0,0,0"
                                     Style="{StaticResource InputBoxStyle}"
                                     CharacterCasing="Upper"
                                     MaxLength="6"
                                     TextChanged="TxtHex_TextChanged"/>
                            <Border Width="24" Height="24" Margin="12,0,0,0" 
                                    CornerRadius="6"
                                    BorderBrush="{StaticResource CardBorder}" BorderThickness="1">
                                <Border.Background>
                                    <SolidColorBrush x:Name="SmallPreviewBrush" Color="#FF0000"/>
                                </Border.Background>
                            </Border>
                        </StackPanel>

                        <TextBlock Margin="0,12,0,0"
                                   Text="点击或拖动取色；方向键微调"
                                   Foreground="{StaticResource SubtitleBrush}"
                                   FontSize="11"
                                   TextWrapping="Wrap"/>
                    </StackPanel>
                </Border>

                <!-- 预设 -->
                <Border Grid.Column="4" Style="{StaticResource CardBorderStyle}">
                    <StackPanel>
                        <TextBlock Text="预设色彩" FontSize="14" FontWeight="SemiBold" Foreground="{StaticResource SubtitleBrush}"/>
                        <UniformGrid Rows="2" Columns="6" Margin="0,8,0,0">
                            <Button Background="#FFEB5757" Style="{StaticResource SecondaryButtonStyle}" Click="Preset_Click" Padding="0" Margin="2"/>
                            <Button Background="#FF27AE60" Style="{StaticResource SecondaryButtonStyle}" Click="Preset_Click" Padding="0" Margin="2"/>
                            <Button Background="#FF2D9CDB" Style="{StaticResource SecondaryButtonStyle}" Click="Preset_Click" Padding="0" Margin="2"/>
                            <Button Background="#FFF2C94C" Style="{StaticResource SecondaryButtonStyle}" Click="Preset_Click" Padding="0" Margin="2"/>
                            <Button Background="#FFBB6BD9" Style="{StaticResource SecondaryButtonStyle}" Click="Preset_Click" Padding="0" Margin="2"/>
                            <Button Background="#FF56CCF2" Style="{StaticResource SecondaryButtonStyle}" Click="Preset_Click" Padding="0" Margin="2"/>

                            <Button Background="#FF6FCF97" Style="{StaticResource SecondaryButtonStyle}" Click="Preset_Click" Padding="0" Margin="2"/>
                            <Button Background="#FFA06BE0" Style="{StaticResource SecondaryButtonStyle}" Click="Preset_Click" Padding="0" Margin="2"/>
                            <Button Background="#FFFF8F5B" Style="{StaticResource SecondaryButtonStyle}" Click="Preset_Click" Padding="0" Margin="2"/>
                            <Button Background="#FF8B54FF" Style="{StaticResource SecondaryButtonStyle}" Click="Preset_Click" Padding="0" Margin="2"/>
                            <Button Background="#FF4BD4D4" Style="{StaticResource SecondaryButtonStyle}" Click="Preset_Click" Padding="0" Margin="2"/>
                            <Button Background="#FFBDBDBD" Style="{StaticResource SecondaryButtonStyle}" Click="Preset_Click" Padding="0" Margin="2"/>
                        </UniformGrid>

                        <TextBlock Text="当前颜色" Margin="0,14,0,4" Foreground="{StaticResource SubtitleBrush}"/>
                        <Border Height="70" CornerRadius="8" BorderBrush="{StaticResource CardBorder}" BorderThickness="1">
                            <Border.Background>
                                <SolidColorBrush x:Name="LargePreviewBrush" Color="#FFA000"/>
                            </Border.Background>
                            <TextBlock x:Name="PreviewLabel"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center"
                                       FontWeight="Bold"
                                       FontSize="16"
                                       Foreground="{StaticResource TitleBrush}"/>
                        </Border>
                    </StackPanel>
                </Border>
            </Grid>

            <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,14,0,0">
                <Button Content="应用" Width="100" Style="{StaticResource ActionButtonStyle}" Click="Apply_Click"/>
                <Button Content="取消" Width="100" Style="{StaticResource SecondaryButtonStyle}" Click="Cancel_Click"/>
            </StackPanel>
        </Grid>
    </Border>
</Window>